<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div class="navbar">
        <h2>Student Dashboard</h2>
        <button onclick="logout()">Logout</button>
    </div>
    
    <div class="container">
        <div id="notifications"></div>
        
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="categoryFilter" placeholder="Filter by Category (e.g., IT)" style="margin-bottom: 0;">
            <button onclick="fetchJobs()" style="background-color: #007bff; white-space: nowrap;">Search Jobs</button>
        </div>
        
        <div id="job-list"></div>
    </div>

    <script>
        const studentId = localStorage.getItem('studentId');
        if (!studentId) window.location.href = '/auth.html';

        function logout() {
            localStorage.clear();
            window.location.href = '/auth.html';
        }

        const socket = io();
        const notificationDiv = document.getElementById('notifications');
        const jobListDiv = document.getElementById('job-list');

        socket.on('new_job_alert', (job) => {
            notificationDiv.innerText = `ðŸ”” New Job Posted: ${job.title} (${job.category})!`;
            notificationDiv.style.display = 'block';
            setTimeout(() => { notificationDiv.style.display = 'none'; }, 5000);
            fetchJobs(); 
        });

        async function fetchJobs() {
            const category = document.getElementById('categoryFilter').value;
            const queryArgs = category ? `(category: "${category}")` : '';
            
            const query = `
                query {
                    getJobs${queryArgs} {
                        id
                        title
                        description
                        category
                        jd_link
                    }
                }
            `;
            const response = await fetch('/graphql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const result = await response.json();
            
            jobListDiv.innerHTML = '';
            if (result.data.getJobs.length === 0) {
                jobListDiv.innerHTML = '<p>No jobs found.</p>';
                return;
            }

            result.data.getJobs.forEach(job => {
                jobListDiv.innerHTML += `
                    <div class="job-card">
                        <h3>${job.title}</h3>
                        <p style="color: #666;"><strong>Category:</strong> ${job.category}</p>
                        <p>${job.description}</p>
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 15px;">
                            <button onclick="applyForJob(${job.id})">Apply Now</button>
                            <a href="${job.jd_link}" target="_blank" style="color: #007bff; text-decoration: none; font-weight: bold;">ðŸ“„ View JD (Drive)</a>
                        </div>
                    </div>
                `;
            });
        }

        async function applyForJob(jobId) {
            const query = `
                mutation {
                    applyForJob(jobId: "${jobId}", studentId: "${studentId}") { id }
                }
            `;
            await fetch('/graphql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            alert('Applied successfully!');
        }

        fetchJobs();
    </script>
</body>
</html>