<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Dashboard | Job Portal</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh;">
    <nav class="navbar">
        <a href="index.html" class="logo">SupersetClone</a>
        <div class="nav-links">
            <button class="btn-primary" onclick="logout()" style="background: #dc3545;">Logout</button>
        </div>
    </nav>
    
    <div class="container" style="flex-grow: 1; display: grid; grid-template-columns: 1fr 2fr; gap: 30px;">
        <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h3 style="margin-top: 0;">Post a New Job</h3>
            <form id="jobForm">
                <input type="text" id="title" placeholder="Job Title" required>
                <textarea id="description" rows="4" placeholder="Job Description" required></textarea>
                <input type="text" id="category" placeholder="Category (e.g., IT, Finance)" required>
                <input type="url" id="jd_link" placeholder="Google Drive JD Link" required>
                <button type="submit" class="btn-primary" style="width: 100%;">Post Job</button>
            </form>
        </div>

        <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h3 style="margin: 0;">My Posted Jobs & Applicants</h3>
                <button class="btn-outline" onclick="fetchMyJobs()">Refresh</button>
            </div>
            <div id="my-jobs-list"></div>
        </div>
    </div>

    <script>
        const companyId = localStorage.getItem('companyId');
        if (!companyId) window.location.href = '/login.html';

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category').value;
            const jd_link = document.getElementById('jd_link').value;

            const query = `mutation { createJob(title: "${title}", description: "${description}", category: "${category}", jd_link: "${jd_link}", companyId: "${companyId}") { id } }`;
            await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            alert('Job Posted Successfully!');
            e.target.reset();
            fetchMyJobs();
        });

        async function fetchMyJobs() {
            const query = `query { getCompanyJobs(companyId: "${companyId}") { id title category } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            
            const jobsListDiv = document.getElementById('my-jobs-list');
            jobsListDiv.innerHTML = '';
            
            for (const job of result.data.getCompanyJobs) {
                const applicantsHtml = await fetchApplicants(job.id);
                jobsListDiv.innerHTML += `
                    <div style="border: 1px solid #dee2e6; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <div style="display:flex; justify-content:space-between;">
                            <h4 style="margin-top: 0; color: #0d6efd;">${job.title}</h4>
                            <a href="/api/export/applicants/${job.id}" class="btn-outline" style="padding: 2px 10px; font-size:12px;">Export CSV</a>
                        </div>
                        <h5 style="margin-bottom: 10px; color: #495057;">Applicants:</h5>
                        ${applicantsHtml || '<p style="color:#6c757d; font-size:14px; margin:0;">No applicants yet.</p>'}
                    </div>
                `;
            }
        }

        async function fetchApplicants(jobId) {
            const query = `query { getApplicants(jobId: "${jobId}") { id status resume_link student { name email } interview { interview_date meeting_link } } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            if (!result.data.getApplicants || !result.data.getApplicants.length) return '';
            
            return result.data.getApplicants.map(app => `
                <div style="background: #f8f9fa; padding: 10px; border-left: 3px solid #0d6efd; margin-bottom: 10px; border-radius: 3px;">
                    <strong>${app.student.name}</strong> (${app.student.email})<br>
                    <a href="${app.resume_link}" target="_blank" style="font-size:14px;">View Resume</a><br>
                    
                    <div style="margin-top:10px; display:flex; gap:10px; align-items:center;">
                        <select id="status-${app.id}" onchange="updateStatus(${app.id})" style="margin-bottom:0; width:auto;">
                            <option value="Pending" ${app.status==='Pending'?'selected':''}>Pending</option>
                            <option value="Shortlisted" ${app.status==='Shortlisted'?'selected':''}>Shortlisted</option>
                            <option value="Interviewing" ${app.status==='Interviewing'?'selected':''}>Interviewing</option>
                            <option value="Hired" ${app.status==='Hired'?'selected':''}>Hired</option>
                            <option value="Rejected" ${app.status==='Rejected'?'selected':''}>Rejected</option>
                        </select>
                        <button class="btn-outline" style="padding: 5px;" onclick="scheduleInterview(${app.id})">Schedule Interview</button>
                    </div>
                    ${app.interview ? `<div style="font-size:12px; margin-top:5px; color:green;">Interview: ${new Date(Number(app.interview.interview_date)).toLocaleString()} - <a href="${app.interview.meeting_link}">Join</a></div>` : ''}
                </div>
            `).join('');
        }

        async function updateStatus(applicationId) {
            const status = document.getElementById(`status-${applicationId}`).value;
            const query = `mutation { updateApplicationStatus(applicationId: "${applicationId}", status: "${status}") { id } }`;
            await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            alert('Status updated & email sent!');
        }

        async function scheduleInterview(applicationId) {
            const dateStr = prompt("Enter interview date (YYYY-MM-DD HH:MM):");
            const link = prompt("Enter meeting link:");
            if(!dateStr || !link) return;

            const date = new Date(dateStr).getTime().toString();
            const query = `mutation { scheduleInterview(applicationId: "${applicationId}", interview_date: "${date}", meeting_link: "${link}") { id } }`;
            await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            alert('Interview scheduled!');
            fetchMyJobs();
        }

        fetchMyJobs();
    </script>
</body>
</html>