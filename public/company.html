<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="navbar">
        <h2>Company Dashboard</h2>
        <button onclick="logout()">Logout</button>
    </div>
    
    <div class="container grid">
        <div>
            <h3>Post a New Job</h3>
            <form id="jobForm">
                <input type="text" id="title" placeholder="Job Title" required>
                <textarea id="description" rows="4" placeholder="Job Description" required></textarea>
                <input type="text" id="category" placeholder="Category (e.g., IT, Finance)" required>
                <input type="url" id="jd_link" placeholder="Google Drive JD Link" required>
                <button type="submit">Post Job</button>
            </form>
        </div>

        <div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>My Posted Jobs & Applicants</h3>
                <button style="background-color: #007bff; padding: 5px 10px; font-size: 14px;" onclick="fetchMyJobs()">Refresh</button>
            </div>
            <div id="my-jobs-list"></div>
        </div>
    </div>

    <script>
        const companyId = localStorage.getItem('companyId');
        if (!companyId) window.location.href = '/auth.html';

        function logout() {
            localStorage.clear();
            window.location.href = '/auth.html';
        }

        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category').value;
            const jd_link = document.getElementById('jd_link').value;

            const query = `
                mutation {
                    createJob(title: "${title}", description: "${description}", category: "${category}", jd_link: "${jd_link}", companyId: "${companyId}") {
                        id
                    }
                }
            `;
            
            await fetch('/graphql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            alert('Job Posted Successfully!');
            e.target.reset();
            fetchMyJobs();
        });

        async function fetchMyJobs() {
            const query = `
                query {
                    getCompanyJobs(companyId: "${companyId}") {
                        id
                        title
                        category
                    }
                }
            `;
            const response = await fetch('/graphql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const result = await response.json();
            
            const jobsListDiv = document.getElementById('my-jobs-list');
            jobsListDiv.innerHTML = '';
            
            for (const job of result.data.getCompanyJobs) {
                const applicantsHtml = await fetchApplicants(job.id);
                jobsListDiv.innerHTML += `
                    <div class="job-card">
                        <h4>${job.title} <span style="color:#666; font-size: 14px;">(${job.category})</span></h4>
                        <h5 style="margin-bottom: 5px;">Applicants:</h5>
                        ${applicantsHtml || '<p style="color:#888; font-size:14px; margin-top:0;">No applicants yet.</p>'}
                    </div>
                `;
            }
        }

        async function fetchApplicants(jobId) {
            const query = `
                query {
                    getApplicants(jobId: "${jobId}") {
                        status
                        student { name email }
                    }
                }
            `;
            const response = await fetch('/graphql', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query })
            });
            const result = await response.json();
            if (!result.data.getApplicants.length) return '';
            
            return result.data.getApplicants.map(app => `
                <div class="applicant">
                    <strong>${app.student.name}</strong> (${app.student.email})<br>
                    <small>Status: ${app.status}</small>
                </div>
            `).join('');
        }

        fetchMyJobs();
    </script>
</body>
</html>