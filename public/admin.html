<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | CampusLink</title>
    <link rel="stylesheet" href="style.css">
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh; background-color: #f4f7f6;">
    <nav class="navbar" style="background-color: #343a40;">
        <a href="index.html" class="logo" style="color: #fff;">CampusLink Admin</a>
        <div class="nav-links">
            <button class="btn-primary" onclick="logout()" style="background: #dc3545;">Exit Admin</button>
        </div>
    </nav>
    
    <div class="container" style="flex-grow: 1; max-width: 1400px; display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        
        <div>
            <h2 style="color: #343a40; border-bottom: 2px solid #dee2e6; padding-bottom: 10px;">Placement Overview</h2>
            
            <div id="analytics-cards" style="display: flex; gap: 20px; margin-bottom: 30px;">
                <div style="flex: 1; background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid #0d6efd; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="margin: 0; color: #6c757d;">Students</h5>
                    <h2 style="margin: 5px 0 0 0; color: #343a40;" id="stat-students">0</h2>
                </div>
                <div style="flex: 1; background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid #ffc107; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="margin: 0; color: #6c757d;">Approved Jobs</h5>
                    <h2 style="margin: 5px 0 0 0; color: #343a40;" id="stat-jobs">0</h2>
                </div>
                <div style="flex: 1; background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid #17a2b8; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="margin: 0; color: #6c757d;">Apps</h5>
                    <h2 style="margin: 5px 0 0 0; color: #343a40;" id="stat-apps">0</h2>
                </div>
                <div style="flex: 1; background: #fff; padding: 15px; border-radius: 8px; border-left: 5px solid #28a745; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                    <h5 style="margin: 0; color: #6c757d;">Hired</h5>
                    <h2 style="margin: 5px 0 0 0; color: #343a40;" id="stat-hired">0</h2>
                </div>
            </div>

            <div style="margin-bottom: 30px;">
                <h3 style="color: #dc3545;">Pending Job Approvals</h3>
                <div id="pending-jobs-list" style="display: grid; grid-template-columns: 1fr; gap: 15px;"></div>
            </div>

            <h3 style="color: #343a40;">All Approved Platform Jobs</h3>
            <button class="btn-primary" onclick="fetchAllJobs()" style="background-color: #343a40; margin-bottom: 20px;">Load Approved Jobs</button>
            <div id="admin-dashboard-content" style="display: grid; grid-template-columns: 1fr; gap: 20px;"></div>
        </div>

        <div>
            <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: sticky; top: 20px;">
                <h3 style="margin-top: 0;">Post Campus Notice</h3>
                <form id="noticeForm">
                    <input type="text" id="notice-title" placeholder="Notice Title (e.g., TCS Drive Update)" required>
                    <textarea id="notice-content" rows="6" placeholder="Write announcement details here..." required></textarea>
                    <button type="submit" class="btn-primary" style="width: 100%;">Broadcast Notice</button>
                </form>
            </div>
        </div>

    </div>

    <script>
        const adminId = localStorage.getItem('adminId');
        if (!adminId) window.location.href = '/login.html';

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        async function fetchAnalytics() {
            const query = `query { getAdminAnalytics { totalStudents totalJobs totalApplications totalHired } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            if (result.data && result.data.getAdminAnalytics) {
                document.getElementById('stat-students').innerText = result.data.getAdminAnalytics.totalStudents;
                document.getElementById('stat-jobs').innerText = result.data.getAdminAnalytics.totalJobs;
                document.getElementById('stat-apps').innerText = result.data.getAdminAnalytics.totalApplications;
                document.getElementById('stat-hired').innerText = result.data.getAdminAnalytics.totalHired;
            }
        }

        async function fetchPendingJobs() {
            const query = `query { getPendingJobs { id title companyId category description jd_link } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            
            const list = document.getElementById('pending-jobs-list');
            list.innerHTML = '';
            
            if(!result.data.getPendingJobs || result.data.getPendingJobs.length === 0) {
                list.innerHTML = '<p style="color: #6c757d;">No pending jobs for approval.</p>';
                return;
            }

            result.data.getPendingJobs.forEach(job => {
                list.innerHTML += `
                    <div style="background: #fff; border: 1px solid #ffc107; padding: 15px; border-radius: 8px;">
                        <h4 style="margin: 0;">${job.title}</h4>
                        <p style="margin: 5px 0; font-size: 13px; color: #6c757d;">Category: ${job.category} | Company ID: ${job.companyId}</p>
                        <p style="font-size: 14px;">${job.description}</p>
                        <a href="${job.jd_link}" target="_blank" style="font-size: 13px; color: #0d6efd;">View JD Link</a>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn-primary" style="background: #28a745; padding: 5px 15px;" onclick="updateJobStatus(${job.id}, 'Approved')">Approve & Broadcast</button>
                            <button class="btn-primary" style="background: #dc3545; padding: 5px 15px;" onclick="updateJobStatus(${job.id}, 'Rejected')">Reject</button>
                        </div>
                    </div>
                `;
            });
        }

        async function updateJobStatus(jobId, status) {
            const query = `mutation { updateJobStatus(jobId: "${jobId}", status: "${status}") { id } }`;
            await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            fetchPendingJobs();
            fetchAllJobs();
            fetchAnalytics();
        }

        async function fetchAllJobs() {
            const query = `query { getJobs(limit: 100, offset: 0) { id title category companyId status } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            const contentDiv = document.getElementById('admin-dashboard-content');
            contentDiv.innerHTML = '';
            for (const job of result.data.getJobs) {
                const applicantsHtml = await fetchApplicants(job.id);
                contentDiv.innerHTML += `
                    <div style="background: #fff; border: 1px solid #dee2e6; padding: 20px; border-radius: 8px;">
                        <div style="display:flex; justify-content:space-between;">
                            <h4 style="margin: 0; color: #343a40;">${job.title}</h4>
                            <a href="/api/export/applicants/${job.id}" class="btn-outline" style="padding: 2px 10px; font-size: 12px;">Export CSV</a>
                        </div>
                        <p style="margin: 5px 0 10px 0; font-size: 12px; color: #6c757d;">Cat: ${job.category} | Status: <span style="color: #28a745; font-weight: bold;">${job.status}</span></p>
                        <div style="max-height: 200px; overflow-y: auto;">${applicantsHtml || '<p style="font-size:12px;">No applications.</p>'}</div>
                    </div>
                `;
            }
        }

        async function fetchApplicants(jobId) {
            const query = `query { getApplicants(jobId: "${jobId}") { id status resume_link student { name email } } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            if (!result.data.getApplicants || !result.data.getApplicants.length) return '';
            return result.data.getApplicants.map(app => `
                <div style="background: #f8f9fa; padding: 10px; margin-bottom: 5px; font-size: 13px;">
                    <strong>${app.student.name}</strong> - <span>${app.status}</span>
                </div>
            `).join('');
        }

        document.getElementById('noticeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('notice-title').value;
            const content = document.getElementById('notice-content').value.replace(/\n/g, '\\n');
            const query = `mutation { createNotice(title: "${title}", content: "${content}") { id } }`;
            await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            alert('Notice broadcasted successfully!');
            e.target.reset();
        });

        fetchAnalytics();
        fetchPendingJobs();
    </script>
</body>
</html>