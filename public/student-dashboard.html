<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard | Job Portal</title>
    <link rel="stylesheet" href="style.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body style="display: flex; flex-direction: column; min-height: 100vh;">
    <nav class="navbar">
        <a href="index.html" class="logo">SupersetClone</a>
        <div class="nav-links">
            <button class="btn-outline" onclick="window.location.href='/student-profile.html'" style="margin-right: 15px;">My Profile</button>
            <button class="btn-primary" onclick="logout()" style="background: #dc3545;">Logout</button>
        </div>
    </nav>
    
    <div class="container" style="flex-grow: 1; display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
        
        <div>
            <div id="notifications" style="background: #ffc107; padding: 10px; border-radius: 5px; margin-bottom: 20px; display: none; font-weight: bold;"></div>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="categoryFilter" placeholder="Filter by Category (e.g., IT)" style="margin-bottom: 0;">
                <button class="btn-primary" onclick="currentPage = 0; fetchJobs()" style="white-space: nowrap;">Search Jobs</button>
            </div>
            
            <div id="job-list"></div>
            
            <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                <button class="btn-outline" onclick="prevPage()">Previous</button>
                <button class="btn-outline" onclick="nextPage()">Next</button>
            </div>
        </div>

        <div>
            <div style="background: #fff; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: sticky; top: 20px;">
                <h3 style="margin-top: 0; border-bottom: 2px solid #0d6efd; padding-bottom: 10px;">üìå Campus Notices</h3>
                <div id="notice-list" style="max-height: 500px; overflow-y: auto;"></div>
            </div>
        </div>

    </div>

    <script>
        const studentId = localStorage.getItem('studentId');
        if (!studentId) window.location.href = '/login.html';
        
        let currentPage = 0;
        const limit = 5;

        function logout() {
            localStorage.clear();
            window.location.href = '/login.html';
        }

        const socket = io();
        const notificationDiv = document.getElementById('notifications');
        const jobListDiv = document.getElementById('job-list');

        socket.on('new_job_alert', (job) => {
            notificationDiv.innerText = `üîî New Job Posted: ${job.title} (${job.category})!`;
            notificationDiv.style.display = 'block';
            setTimeout(() => { notificationDiv.style.display = 'none'; }, 5000);
            fetchJobs(); 
        });

        socket.on('new_notice', (notice) => {
            fetchNotices();
            alert(`üì¢ New Announcement: ${notice.title}`);
        });

        async function fetchNotices() {
            const query = `query { getNotices { id title content date_posted } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            
            const noticeListDiv = document.getElementById('notice-list');
            noticeListDiv.innerHTML = '';
            
            if (!result.data.getNotices || result.data.getNotices.length === 0) {
                noticeListDiv.innerHTML = '<p style="color: #6c757d; font-size: 14px;">No new announcements.</p>';
                return;
            }

            result.data.getNotices.forEach(notice => {
                const date = new Date(Number(notice.date_posted)).toLocaleDateString();
                noticeListDiv.innerHTML += `
                    <div style="background: #f8f9fa; border-left: 4px solid #0d6efd; padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                        <h5 style="margin: 0 0 5px 0; color: #343a40;">${notice.title}</h5>
                        <p style="margin: 0 0 5px 0; font-size: 13px; color: #495057;">${notice.content}</p>
                        <small style="color: #6c757d;">Posted: ${date}</small>
                    </div>
                `;
            });
        }

        async function fetchJobs() {
            const category = document.getElementById('categoryFilter').value;
            const queryArgs = `(limit: ${limit}, offset: ${currentPage * limit}${category ? `, category: "${category}"` : ''})`;
            
            const query = `query { getJobs${queryArgs} { id title description category jd_link companyId } }`;
            const response = await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            const result = await response.json();
            
            jobListDiv.innerHTML = '';
            if (!result.data.getJobs || result.data.getJobs.length === 0) {
                jobListDiv.innerHTML = '<p style="color: #6c757d;">No jobs found.</p>';
                return;
            }

            result.data.getJobs.forEach(job => {
                jobListDiv.innerHTML += `
                    <div style="background: #fff; border: 1px solid #dee2e6; padding: 20px; border-radius: 8px; margin-bottom: 15px;">
                        <div style="display:flex; justify-content:space-between;">
                            <h3 style="margin-top: 0; color: #0d6efd;">${job.title}</h3>
                            <button class="btn-outline" style="padding: 2px 10px; font-size: 12px;" onclick="rateCompany(${job.companyId})">‚≠ê Rate Company</button>
                        </div>
                        <p style="color: #6c757d; font-size: 14px;"><strong>Category:</strong> ${job.category}</p>
                        <p>${job.description}</p>
                        <input type="url" id="resume-${job.id}" placeholder="Google Drive Resume Link" style="margin-top: 10px;">
                        <div style="display: flex; gap: 15px; align-items: center; margin-top: 15px;">
                            <button class="btn-primary" onclick="applyForJob(${job.id})">Apply Now</button>
                            <a href="${job.jd_link}" target="_blank" style="color: #0d6efd; text-decoration: none; font-weight: bold;">üìÑ View JD</a>
                        </div>
                    </div>
                `;
            });
        }

        function prevPage() { if (currentPage > 0) { currentPage--; fetchJobs(); } }
        function nextPage() { currentPage++; fetchJobs(); }

        async function applyForJob(jobId) {
            const resume_link = document.getElementById(`resume-${jobId}`).value;
            if (!resume_link) return alert('Please provide a resume link');

            const query = `mutation { applyForJob(jobId: "${jobId}", studentId: "${studentId}", resume_link: "${resume_link}") { id } }`;
            await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            alert('Applied successfully!');
        }

        async function rateCompany(companyId) {
            const rating = prompt("Enter rating (1-5):");
            if (!rating || isNaN(rating) || rating < 1 || rating > 5) return alert("Please enter a valid rating between 1 and 5.");
            const comment = prompt("Enter a brief review comment:");
            
            const query = `mutation { addReview(companyId: "${companyId}", studentId: "${studentId}", rating: ${rating}, comment: "${comment}") { id } }`;
            await fetch('/graphql', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ query }) });
            alert('Review submitted successfully!');
        }

        fetchJobs();
        fetchNotices();
    </script>
</body>
</html>